---
title: "Relationship between Launch Angle and Exit Velocity"
output: html_document
date: "2022-07-24"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
```

## Launch Angle VS Exit Velocity of MLB Batters
This document analyzes the relationship between launch angle and exit velocity of MLB batters during the 2021 season. 

```{r setting up}
#import libraries
library(DBI)
library(RSQLite)
library(baseballr)
library(dplyr)
library(ggplot2)
library(plyr)
library(gridExtra)
library(ggpubr)
library(ggrepel)

#devtools::install_github("BillPetti/baseballr")

# db <- dbConnect(SQLite(), "statcast_db.sqlite")
# dbListTables(db)
# sc <- dbGetQuery(db, "select * from statcast_data")
# dbDisconnect(db)

#Obtain data for MLB season 2021 using function in statcast_scraper.R
# data <- read.csv("C:/Users/12244/CSV_2021/sc.csv")

```

## 1 Exit Velocity vs Launch Angle
```{r}
#Function for filtering data for players with balls in play with 200 balls in play or more

filter_data <- function(data) {
  filtered_data <- data %>%
    filter(type == 'X') %>%
    group_by(player_name) %>%
    dplyr::summarize(BIP = dplyr::n()) %>%
    filter(BIP >= 200)
  return(filtered_data$player_name)
}

```


## Function for plotting exit velocity versus launch angle that gives the maximum exit velocity

```{r}
#Function for plotting Exit Velocity vs Launch Angle for all contacted balls for a batter
plot_ev_vs_la <- function(batter) {
  #Narrow data into Batter Name, Exit Velocity, and Launch Angle with non NA value
  data_batter <- data %>%
  select(player_name, launch_speed, launch_angle) %>%
  na.omit() %>%
  #Label data with launch angle for every bins of width 5 degrees
  filter(player_name == batter) %>%
  mutate(theta5 = 5 * round(launch_angle / 5, 0)) %>%
  arrange(launch_angle)
  
  #Create data set of top 10 percent exit velocity within each bins
  new_df <- data.frame(theta5 = 0, top_10_ev = 0)
  
  for (theta in unique(data_batter$theta5)) {
    n_data <- data_batter %>% 
      filter(theta5 == theta)
    df <- data.frame(theta5 = theta, top_10_ev = quantile(n_data$launch_speed, seq(0, 1, 1/10))[10])
    new_df <- rbind(new_df, df)
  }

  new_df <- new_df[-c(1),]
  
  data_batter <- inner_join(data_batter, new_df, by = "theta5")
  
  top_10_data <- data_batter %>%
    filter(launch_speed >= top_10_ev,
           launch_angle > -40) %>%
    mutate(top_10 = "Yes")
    
  #Join two data
  combined_data <- left_join(data_batter, top_10_data, by = c("player_name", "launch_speed", "launch_angle", "theta5"))
  
  #Indicate whether or not the exit velocity is in top 10 percent
  combined_data <- combined_data %>%
    mutate(top_10 = ifelse(is.na(top_10), "No", top_10)) %>%
    filter(launch_angle > -40)
  
  #Create a quadratic regression for top 10 percent data
  top_10_data$launch_angle2 = top_10_data$launch_angle^2
  
  quadratic_fit <- lm(launch_speed ~ launch_angle + launch_angle2, data = top_10_data)
  
  #Scatter plot data differentiating the top 10 percent points by color and indicating the maximum predicted value for the launch angle that gives the max exit velocity using the quadratic regression
  ggplot(combined_data) + 
    geom_point(aes(launch_angle, launch_speed, color = top_10)) + 
    scale_color_manual(values = c("red", "blue")) + 
    stat_smooth(method = "lm", formula = y ~ x + I(x^2), data = top_10_data, aes(launch_angle, launch_speed), color = "black", se = FALSE) + 
    geom_vline(aes(xintercept = top_10_data$launch_angle[which.max(predict(quadratic_fit))]), linetype = "dashed") + 
    ggtitle(paste("Exit Velocity vs Launch Angle of", batter)) + 
    scale_x_continuous(name = "Launch Angle (deg)", breaks = seq(-40, 80, by = 10)) + 
    scale_y_continuous(name = "Exit Velocity (mph)", breaks = seq(50, 120, by = 20)) + 
    annotate(geom = "text", label = top_10_data$launch_angle[which.max(predict(quadratic_fit))], x = top_10_data$launch_angle[which.max(predict(quadratic_fit))], y = 50, vjust = 1)
}

```

```{r}
#Function to obtain the launch angle that gives the maximum exit velocity when using quadratic fit for all contacted balls
la_for_peak_ev <- function(batter) {
  
  #Narrow data into Batter Name, Exit Velocity, and Launch Angle with non NA value
  test_data <- data %>%
  select(player_name, launch_speed, launch_angle) %>%
  na.omit() %>%
  filter(player_name == batter) %>%
    
  #Label data with launch angle for every bins of width 5 degrees
  mutate(theta5 = 5 * round(launch_angle / 5, 0)) %>%
  arrange(launch_angle)
  
  #Create data set of top 5 exit velocity within each bins
  new_df <- data.frame(theta5 = 0, top_10_ev = 0)

  for (theta in unique(test_data$theta5)) {
    n_data <- test_data %>% 
      filter(theta5 == theta)
    df <- data.frame(theta5 = theta, top_10_ev = quantile(n_data$launch_speed, seq(0, 1, 1/10))[10])
    new_df <- rbind(new_df, df)
  }

  new_df <- new_df[-c(1),]
  
  test_data <- inner_join(test_data, new_df, by = "theta5")

  top_10_data <- test_data %>%
    filter(launch_speed >= top_10_ev,
           launch_angle > -40) %>%
    mutate(top_10 = "Yes")
  
  #Create a quadratic regression for top 10 percent data
  top_10_data$launch_angle2 = top_10_data$launch_angle^2
  
  quadratic_fit <- lm(launch_speed ~ launch_angle + launch_angle2, data = top_10_data)

  #return launch angle that gives the max exit velocity and max exit velocity as a list
  return(list(top_10_data$launch_angle[which.max(predict(quadratic_fit))], max(predict(quadratic_fit))))
}

```


## Computing data for balls in play (use qualified_batters for data)
```{r}
#Obtain data for batters with BIP >= 200, and filter data for only balls in play
qualified_batters <- data %>%
  filter(player_name %in% filter_data(data)) %>%
  filter(type == 'X')

#Obtain total balls in play for a batter
total_BIP <- function(name, data) {
  h_data <- data %>% 
    filter(player_name == name)
  return(nrow(h_data))
}

#Functions to obtain amount of Singles, Doubles, Triples, Home runs, average for balls in play, home run percentage for balls in play
obtain_stats <- function(name, data) {
  h_data <- data %>%
    filter(player_name == name)
  return(table(h_data$events))
}

single_data <- function(name, data) {
  h_data <- data %>%
    filter(player_name == name,
           events == "single")
  return(nrow(h_data))
}

home_run_data <- function(name, data) {
  h_data <- data %>%
    filter(player_name == name,
           events == "home_run")
  return(nrow(h_data))
}

double_data <- function(name, data) {
  h_data <- data %>%
    filter(player_name == name,
           events == "double")
  return(nrow(h_data))
}

triple_data <- function(name, data) {
  h_data <- data %>%
    filter(player_name == name,
           events == "triple")
  return(nrow(h_data))
}

```



```{r}
#Obtain data with batter name, launch angle that gives max exit velocity, and max exit velocity (This includes all contacted balls). 
la_ev_batter <- function(data) {
  df <- data.frame(hitter = " ", launch_angle = 0, exit_velo = 0, BIP = 0, single = 0, double = 0, triple = 0, home_run = 0)
  for(batter in unique(data$player_name)) {
  new_df <- data.frame(hitter = batter, launch_angle = as.numeric(la_for_peak_ev(batter)[1]), exit_velo = as.numeric(la_for_peak_ev(batter)[2]), BIP = total_BIP(batter, data), single = single_data(batter, data), double = double_data(batter, data), triple = triple_data(batter, data), home_run = home_run_data(batter, data))
  df <- rbind(df, new_df)
  }
  df <- df[-c(1), ]
  return(df)
}

#Get data for qualified batters
q_data <- la_ev_batter(qualified_batters)
q_data <- q_data %>%
  arrange(launch_angle)

#player with min launch angle
min_la_player <- q_data %>%
  filter(launch_angle == min(q_data$launch_angle))

min_la_player

#player with max launch angle
max_la_player <- q_data %>%
  filter(launch_angle == max(q_data$launch_angle))

max_la_player

```

# Analysis
## Hitters with highest and lowest launch angles at which their maximum exit velocities are achieved
```{r}
#Hitters with 3 lowest and 3 highest launch angle
plot1 <- ggarrange(plot_ev_vs_la(q_data$hitter[1]), plot_ev_vs_la(q_data$hitter[2]), plot_ev_vs_la(q_data$hitter[3]),
          plot_ev_vs_la(q_data$hitter[length(q_data$hitter)]), plot_ev_vs_la(q_data$hitter[length(q_data$hitter) - 1]), plot_ev_vs_la(q_data$hitter[length(q_data$hitter) - 2]), ncol = 3, nrow = 2)
plot1

```
**Could visually see that hitters with high launch angles that maximizes their exit velocity have upper swing and hitters with low launch angles that maximizes their exit velocity have down swing.**

## Comparing hitters with top home runs, batting average, and slugging percentage (Data taken from 2021 MLB Stats)
```{r}
#Hitters with highest home runs
plot2 <- ggarrange(plot_ev_vs_la("Perez, Salvador"), plot_ev_vs_la("Guerrero Jr., Vladimir"), plot_ev_vs_la("Ohtani, Shohei"), plot_ev_vs_la("Semien, Marcus"), plot_ev_vs_la("Tatis Jr., Fernando"), plot_ev_vs_la("Judge, Aaron"), plot_ev_vs_la("Olson, Matt"), plot_ev_vs_la("Haniger, Mitch"), plot_ev_vs_la("Lowe, Brandon"), plot_ev_vs_la("Devers, Rafael"))
plot2

```

```{r}
#Hitters with highest average
plot3 <- ggarrange(plot_ev_vs_la("Turner, Trea"), plot_ev_vs_la("Gurriel, Yuli"), plot_ev_vs_la("Soto, Juan"), plot_ev_vs_la("Brantley, Michael"), plot_ev_vs_la("Brantley, Michael"), plot_ev_vs_la("Guerrero Jr., Vladimir"), plot_ev_vs_la("Marte, Starling"), plot_ev_vs_la("Harper, Bryce"), plot_ev_vs_la("Anderson, Tim"), plot_ev_vs_la("Castellanos, Nick"), plot_ev_vs_la("Frazier, Adam"))
plot3

```

```{r}
#Hitters with highest slug
plot4 <- ggarrange(plot_ev_vs_la("Harper, Bryce"), plot_ev_vs_la("Tatis Jr., Fernando"), plot_ev_vs_la("Guerrero Jr., Vladimir"), plot_ev_vs_la("Ohtani, Shohei"), plot_ev_vs_la("Castellanos, Nick"), plot_ev_vs_la("Votto, Joey"), plot_ev_vs_la("O'Neill, Tyler"), plot_ev_vs_la("Tucker, Kyle"), plot_ev_vs_la("Judge, Aaron"), plot_ev_vs_la("Perez, Salvador"))
plot4

```


## List of launch angles that gives maximum exit velocities for batters with high stats
```{r}
#list of launch angles for hitters with high home runs
la_top_hr_hitters <- c(unlist(la_for_peak_ev("Perez, Salvador")[1]), unlist(la_for_peak_ev("Guerrero Jr., Vladimir")[1]), unlist(la_for_peak_ev("Ohtani, Shohei")[1]), unlist(la_for_peak_ev("Semien, Marcus")[1]), unlist(la_for_peak_ev("Tatis Jr., Fernando")[1]), unlist(la_for_peak_ev("Judge, Aaron")[1]), unlist(la_for_peak_ev("Olson, Matt")[1]), unlist(la_for_peak_ev("Haniger, Mitch")[1]), unlist(la_for_peak_ev("Lowe, Brandon")[1]), unlist(la_for_peak_ev("Devers, Rafael")[1]))
mean(la_top_hr_hitters)
summary(la_top_hr_hitters)
sd(la_top_hr_hitters)

```

```{r}
#list of launch angles for hitters with high batting average
la_top_ave_hitters <- c(unlist(la_for_peak_ev("Turner, Trea")[1]), unlist(la_for_peak_ev("Gurriel, Yuli")[1]), unlist(la_for_peak_ev("Soto, Juan")[1]), unlist(la_for_peak_ev("Brantley, Michael")[1]), unlist(la_for_peak_ev("Guerrero Jr., Vladimir")[1]), unlist(la_for_peak_ev("Marte, Starling")[1]), unlist(la_for_peak_ev("Harper, Bryce")[1]), unlist(la_for_peak_ev("Anderson, Tim")[1]), unlist(la_for_peak_ev("Castellanos, Nick")[1]), unlist(la_for_peak_ev("Frazier, Adam")[1]))
mean(la_top_ave_hitters)
summary(la_top_ave_hitters)
sd(la_top_ave_hitters)

```

```{r}
#list of launch angles for hitters with high slugging percentage
la_top_slg_hitters <- c(unlist(la_for_peak_ev("Harper, Bryce")[1]), unlist(la_for_peak_ev("Tatis Jr., Fernando")[1]), unlist(la_for_peak_ev("Guerrero Jr., Vladimir")[1]), unlist(la_for_peak_ev("Ohtani, Shohei")[1]), unlist(la_for_peak_ev("Castellanos, Nick")[1]), unlist(la_for_peak_ev("Votto, Joey")[1]), unlist(la_for_peak_ev("O'Neill, Tyler")[1]), unlist(la_for_peak_ev("Tucker, Kyle")[1]), unlist(la_for_peak_ev("Judge, Aaron")[1]), unlist(la_for_peak_ev("Perez, Salvador")[1]))
mean(la_top_slg_hitters)
summary(la_top_slg_hitters)
sd(la_top_slg_hitters)

```
**Hitters with top home runs and slug tend to have higher launch angle that maximizes their exit velocity then hitters with high batting average.**


## List of max exit velocities for players with high stats
```{r}
#list of max exit velocities for hitters with high home runs
ev_top_hr_hitters <- c(unlist(la_for_peak_ev("Perez, Salvador")[2]), unlist(la_for_peak_ev("Guerrero Jr., Vladimir")[2]), unlist(la_for_peak_ev("Ohtani, Shohei")[2]), unlist(la_for_peak_ev("Semien, Marcus")[2]), unlist(la_for_peak_ev("Tatis Jr., Fernando")[2]), unlist(la_for_peak_ev("Judge, Aaron")[2]), unlist(la_for_peak_ev("Olson, Matt")[2]), unlist(la_for_peak_ev("Haniger, Mitch")[2]), unlist(la_for_peak_ev("Lowe, Brandon")[2]), unlist(la_for_peak_ev("Devers, Rafael")[2]))
mean(ev_top_hr_hitters)
summary(ev_top_hr_hitters)
sd(ev_top_hr_hitters)

#list of max exit velocities for hitters with high batting average
ev_top_ave_hitters <- c(unlist(la_for_peak_ev("Turner, Trea")[2]), unlist(la_for_peak_ev("Gurriel, Yuli")[2]), unlist(la_for_peak_ev("Soto, Juan")[2]), unlist(la_for_peak_ev("Brantley, Michael")[2]), unlist(la_for_peak_ev("Guerrero Jr., Vladimir")[2]), unlist(la_for_peak_ev("Marte, Starling")[2]), unlist(la_for_peak_ev("Harper, Bryce")[2]), unlist(la_for_peak_ev("Anderson, Tim")[2]), unlist(la_for_peak_ev("Castellanos, Nick")[2]), unlist(la_for_peak_ev("Frazier, Adam")[2]))
mean(ev_top_ave_hitters)
summary(ev_top_ave_hitters)
sd(ev_top_ave_hitters)

#list of max exit velocities for hitters with high slugging percentage
ev_top_slg_hitters <- c(unlist(la_for_peak_ev("Harper, Bryce")[2]), unlist(la_for_peak_ev("Tatis Jr., Fernando")[2]), unlist(la_for_peak_ev("Guerrero Jr., Vladimir")[2]), unlist(la_for_peak_ev("Ohtani, Shohei")[2]), unlist(la_for_peak_ev("Castellanos, Nick")[2]), unlist(la_for_peak_ev("Votto, Joey")[2]), unlist(la_for_peak_ev("O'Neill, Tyler")[2]), unlist(la_for_peak_ev("Tucker, Kyle")[2]), unlist(la_for_peak_ev("Judge, Aaron")[2]), unlist(la_for_peak_ev("Perez, Salvador")[2]))
mean(ev_top_slg_hitters)
summary(ev_top_slg_hitters)
sd(ev_top_slg_hitters)
```
Hitters with top home runs and slug tend to have higher peak exit velocity then hitters with high batting average.

## 2 Relationship between Home Run Percentage and Launch Angle + Exit Velocity

```{r}
#Get data for qualified batters
q_df <- q_data %>%
  mutate(batting_average_for_BIP = (single + double + triple + home_run) / BIP,
         home_run_for_BIP = home_run / BIP,
         slug_for_BIP = (single  + double * 2 + triple * 3 + home_run * 4) / BIP)

#write.csv(q_df,"C:/Users/12244/R_projects2022/Physics/q_df.csv", row.names = FALSE)


```

```{r}
#Plot home run per balls in play versus launch angle of qualified batters
plot_hr <- ggplot(q_df, aes(launch_angle, home_run_for_BIP, label = hitter)) + geom_point() + geom_smooth() +
  geom_label_repel() + xlab("Launch Angle that Gives Maximum Exit Velocity") + ylab("Home Run Percentage for BIP")

plot_hr

```
```{r}
#Home run percentage versus peak exit velocity
plot_hr2 <- ggplot(q_df, aes(exit_velo, home_run_for_BIP, label = hitter)) + geom_point() + geom_smooth() + 
  geom_label_repel() + xlab("Peak Exit Velocity") + ylab("Home Run Percentage for BIP")

plot_hr2
```

## Creating a model for home run percentage using launch angle that maxmizes exit velocity and peak exit velocity
```{r}
#Make model for home run percentage using launch angle and exit velocity
model <- lm(formula = home_run_for_BIP ~ launch_angle + exit_velo, data = q_df)
summary(model)

#Create dataframe for predicted and observed data
data_mod <- data.frame(Predicted = predict(model),  
                       Observed = q_df$home_run_for_BIP)
#plot prediction and actual data
plot_fit <- ggplot(data_mod, aes(Predicted, Observed)) + geom_point() + 
  geom_abline(intercept = 0,
              slope = 1,
              color = "red",
              size = 2)
plot_fit
```
With a residual standard error of 0.01632, the model fits decent to the actual data.


```{r}
#Data with prediction for homerun for balls in play
data_compare <- q_df %>%
  mutate(predicted_hr_for_BIP = predict(model))

#Set launch angle constant
theta19 <- data_compare %>%
  filter(launch_angle <= 20, launch_angle >= 18)

plot_theta19 <- ggplot(theta19, aes(exit_velo, home_run_for_BIP)) + geom_point() + geom_point(aes(exit_velo, predicted_hr_for_BIP), color = "green")
plot_theta19

#Set exit velocity constant
ev_105 <- data_compare %>%
  filter(round(exit_velo) == 105)

plot_ev_105 <- ggplot(ev_105, aes(launch_angle, home_run_for_BIP)) + geom_point() + geom_point(aes(launch_angle, predicted_hr_for_BIP), color = "green") 
plot_ev_105
```
The predicted data which is represented by green dots are close to the average of the actual data.

## 3 Relationship between launch angle and strikeout percentage
```{r}
#Filter data to batters with greater than or equal to 200 BIP
strikeout_data <- data %>%
  filter(player_name %in% filter_data(data))

#Function for obtaining strikeout percentage for batters
get_strikeouts <- function(player, data) {
  data <- data %>%
    filter(type == "X" | events == "strikeout",
           player_name == player) %>%
    mutate(K = ifelse(events %in% c("strikeout", "strikeout_double_play"), 1, 0))
   summary_data <- data %>%
     dplyr::summarize(t_K = sum(K),
               AB = n(),
               Strikeouts = t_K / AB)
   return(summary_data$Strikeouts)
}

#Function to obtain data with batter name, launch angle that gives max exit velocity, and strikeout percentage
la_k_batter <- function(data) {
  df <- data.frame(hitter = " ", launch_angle = 0, exit_velo = 0, strikeouts = 0)
  for(batter in unique(data$player_name)) {
  new_df <- data.frame(hitter = batter, launch_angle = as.numeric(la_for_peak_ev(batter)[1]), exit_velo = as.numeric(la_for_peak_ev(batter)[2]), strikeouts = get_strikeouts(batter, data))
  df <- rbind(df, new_df)
  }
  df <- df[-c(1), ]
  return(df)
}

#Obtain data with batter name, launch angle that gives max exit velocity, and strikeout percentage
k_data <- la_k_batter(strikeout_data)

#Plot launch angle versus strikeout percentage
k_plot <- ggplot(k_data, aes(launch_angle, strikeouts, label = hitter)) + geom_point() + geom_smooth() + geom_text_repel() + xlab("Launch Angle that Gives the Maximum Exit Velocity") + ylab("Strikeout Percentage")
k_plot
```
As seen by the plot above, the strikeout percentage increases gradually as the launch angle that gives the maximum exit velocity increases. Thus, players with leveled swing tend to have lower strikeout percentage than players with non-leveled swing.


## Exit velocity / Max Exit Velocity vs Launch angle 
```{r}
h_data <- q_data
colnames(h_data)[colnames(h_data) == "hitter"] <- "player_name"
colnames(h_data)[colnames(h_data) == "exit_velo"] <- "max_ev"

ev_data <- h_data %>%
  select(player_name, max_ev)


new_data <- inner_join(data, ev_data, by = c("player_name"))
new_data2 <- new_data %>%
  select(player_name, max_ev, launch_angle, launch_speed, description, events) %>%
  mutate(scaled_ev = launch_speed / max_ev) %>%
  na.omit()
  
Ohtani_data <- new_data2 %>%
  filter(player_name == "Ohtani, Shohei")
ggplot(Ohtani_data, aes(launch_angle, scaled_ev)) + geom_point()


```

```{r}
#Function for plotting Exit Velocity vs Launch Angle for a batter
plot_scaled_ev_vs_la <- function(batter) {
  data_batter <- new_data2 %>%
  #Label data with launch angle for every bins of width 5 degrees
    filter(player_name == batter) %>%
    mutate(theta5 = 5 * round(launch_angle / 5, 0)) %>%
    arrange(launch_angle)
  
  #Create data set of top 10 percent exit velocity within each bins
  new_df <- data.frame(theta5 = 0, top_10_ev = 0)
  
  for (theta in unique(data_batter$theta5)) {
    n_data <- data_batter %>% 
      filter(theta5 == theta)
    df <- data.frame(theta5 = theta, top_10_ev = quantile(n_data$scaled_ev, seq(0, 1, 1/10))[10])
    new_df <- rbind(new_df, df)
  }

  new_df <- new_df[-c(1),]
  
  data_batter <- inner_join(data_batter, new_df, by = "theta5")
  
  top_10_data <- data_batter %>%
    filter(scaled_ev >= top_10_ev,
           launch_angle > -40) %>%
    mutate(top_10 = "Yes")
    
  #Join two data
  combined_data <- left_join(data_batter, top_10_data, by = c("player_name", "scaled_ev", "launch_speed", "launch_angle", "theta5", "description", "events", "top_10_ev", "max_ev"))
  
  #Indicate whether or not the exit velocity is in top 10 percent
  combined_data <- combined_data %>%
    mutate(top_10 = ifelse(is.na(top_10), "No", top_10)) %>%
    filter(launch_angle > -40) %>%
    mutate(events = ifelse(events == "", "foul", events))
  
  #Create a quadratic regression for top 10 percent data
  top_10_data$launch_angle2 = top_10_data$launch_angle^2
  
  quadratic_fit <- lm(scaled_ev ~ launch_angle + launch_angle2, data = top_10_data)
  
  #Scatter plot data differentiating the top 10 percent points by color and indicating the maximum predicted value for the launch angle that gives the max exit velocity using the quadratic regression
  #colors <- interaction(combined_data$top_10, combined_data$description)
  ggplot(combined_data) + 
    geom_point(aes(launch_angle, scaled_ev, color = interaction(top_10, description))) + 
    scale_color_manual(values = c("pink", "skyblue", "red", "blue")) +
    stat_smooth(method = "lm", formula = y ~ x + I(x^2), data = top_10_data, aes(launch_angle, scaled_ev), color = "black", se = FALSE) + 
    geom_vline(aes(xintercept = top_10_data$launch_angle[which.max(predict(quadratic_fit))]), linetype = "dashed") + 
    ggtitle(paste("Exit Velocity vs Launch Angle of", batter)) + 
    scale_x_continuous(name = "Launch Angle (deg)", breaks = seq(-40, 80, by = 10)) + 
    scale_y_continuous(name = "Scaled Exit Velocity (mph)", breaks = seq(0.4, 1.2, by = 0.2)) + 
    annotate(geom = "text", label = top_10_data$launch_angle[which.max(predict(quadratic_fit))], x = top_10_data$launch_angle[which.max(predict(quadratic_fit))], y = 1.2, vjust = 1)
}
```


```{r}
plot_scaled_ev_vs_la("Ohtani, Shohei")


```


```{r}
plot_scaled_ev_vs_la("Ohtani, Shohei")

  data_batter <- new_data2 %>%
  #Label data with launch angle for every bins of width 5 degrees
    filter(player_name == "Ohtani, Shohei") %>%
    mutate(theta5 = 5 * round(launch_angle / 5, 0)) %>%
    arrange(launch_angle)
  
  #Create data set of top 10 percent exit velocity within each bins
  new_df <- data.frame(theta5 = 0, top_10_ev = 0)
  
  for (theta in unique(data_batter$theta5)) {
    n_data <- data_batter %>% 
      filter(theta5 == theta)
    df <- data.frame(theta5 = theta, top_10_ev = quantile(n_data$scaled_ev, seq(0, 1, 1/10))[10])
    new_df <- rbind(new_df, df)
  }

  new_df <- new_df[-c(1),]
  
  data_batter <- inner_join(data_batter, new_df, by = "theta5")
  
  top_10_data <- data_batter %>%
    filter(scaled_ev >= top_10_ev,
           launch_angle > -40) %>%
    mutate(top_10 = "Yes")
    
  #Join two data
  combined_data <- left_join(data_batter, top_10_data, by = c("player_name", "scaled_ev", "launch_speed", "launch_angle", "theta5", "description", "events", "top_10_ev", "max_ev"))
  
  #Indicate whether or not the exit velocity is in top 10 percent
  combined_data <- combined_data %>%
    mutate(top_10 = ifelse(is.na(top_10), "No", top_10)) %>%
    filter(launch_angle > -40) %>%
    mutate(events = ifelse(events == "", "foul", events))
  
  #Create a quadratic regression for top 10 percent data
  top_10_data$launch_angle2 = top_10_data$launch_angle^2
  
  quadratic_fit <- lm(scaled_ev ~ launch_angle + launch_angle2, data = top_10_data)
  
  #Scatter plot data differentiating the top 10 percent points by color and indicating the maximum predicted value for the launch angle that gives the max exit velocity using the quadratic regression
  #colors <- interaction(combined_data$top_10, combined_data$description)
  ggplot(combined_data) + 
    geom_point(aes(launch_angle, scaled_ev, color = interaction(top_10, description))) + 
    scale_color_manual(values = c("pink", "skyblue", "red", "blue")) +
    stat_smooth(method = "lm", formula = y ~ x + I(x^2), data = top_10_data, aes(launch_angle, scaled_ev), color = "black", se = FALSE) + 
    geom_vline(aes(xintercept = top_10_data$launch_angle[which.max(predict(quadratic_fit))]), linetype = "dashed") + 
    ggtitle(paste("Exit Velocity vs Launch Angle of", "Shohei, Ohtani")) + 
    scale_x_continuous(name = "Launch Angle (deg)", breaks = seq(-40, 80, by = 10)) + 
    scale_y_continuous(name = "Scaled Exit Velocity (mph)", breaks = seq(0.4, 1.2, by = 0.2)) + 
    annotate(geom = "text", label = top_10_data$launch_angle[which.max(predict(quadratic_fit))], x = top_10_data$launch_angle[which.max(predict(quadratic_fit))], y = 1.2, vjust = 1)
  
  

```


```{r}
ggplot(combined_data) + 
    geom_point(aes(launch_angle, scaled_ev, color = events)) + 
    stat_smooth(method = "lm", formula = y ~ x + I(x^2), data = top_10_data, aes(launch_angle, scaled_ev), color = "black", se = FALSE) + 
    geom_vline(aes(xintercept = top_10_data$launch_angle[which.max(predict(quadratic_fit))]), linetype = "dashed") + 
    ggtitle(paste("Exit Velocity vs Launch Angle of", "Shohei, Ohtani")) + 
    scale_x_continuous(name = "Launch Angle (deg)", breaks = seq(-40, 80, by = 10)) + 
    scale_y_continuous(name = "Scaled Exit Velocity (mph)", breaks = seq(0.4, 1.2, by = 0.2)) + 
    annotate(geom = "text", label = top_10_data$launch_angle[which.max(predict(quadratic_fit))], x = top_10_data$launch_angle[which.max(predict(quadratic_fit))], y = 1.2, vjust = 1) 


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
