---
title: "Swinging Tendecy"
output: html_document
date: '2022-06-11'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#import libraries
library(dplyr)
library(illinibaseball)
library(RMySQL)
library(randomForest)
library(caret)
library(rsample)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(tidyverse)
library(randomForest)
library(metR)

#obtain uiuc data
con <- connect_db("uiuc")
sc <- dbGetQuery(con, paste("select * from fs_pitches where season in (2019, 2020, 2021)"))
dbDisconnect(con)

```

```{r}
swinging_tendecy_contour <- function(data, player) {
  #Add counts and add swung info
  swing <- c("Single", "Foul Ball", "Contact Out", "Swinging Strike", "Home Run", "Error", "Double", "Triple")
  data <- data %>% 
    filter(batter_name == player) %>%
    mutate(ball = as.numeric(balls),
           strike = as.numeric(strikes),
           count = paste(ball, strike, sep = "-"),
           swung = case_when(play_result %in% swing ~ 1, TRUE ~ 0))
  
  #strike zone plot
  k_zone_plot <- ggplot(data, aes(plate_x, plate_z)) +
  geom_segment(aes(x = -0.947, y = 3.6, xend = -0.947, yend = 1.5)) +
  geom_segment(aes(x = -0.947, y = 3.6, xend = 0.947, yend = 3.6)) + 
  geom_segment(aes(x = 0.947, y = 3.6, xend = 0.947, yend = 1.5)) + 
  geom_segment(aes(x = -0.947, y = 1.5, xend = 0.947, yend = 1.5)) +
  coord_equal() +
  scale_x_continuous("Horizontal location (ft.)",
                     limits = c(-2, 2)) +
  scale_y_continuous("Vertical location (ft.)",
                    limits = c(0, 5))
  
  #predict fit
  miggy_loess <- loess(swung ~ plate_x + plate_z, data = data,
                     control = loess.control(surface = "direct"))
  
  #setup grid
  pred_area <- expand.grid(plate_x = seq(-2, 2, by = 0.1),
                         plate_z = seq(0, 6, by = 0.1))
  
  #fill the grid with fit
  pred_area_fit <- pred_area %>%
  mutate(fit = as.numeric(predict(miggy_loess,
                                  newdata = .)))
  
  #plot contour with labels
  k_zone_plot %+%
  filter(pred_area_fit, fit >= 0, fit <= 1) +
  stat_contour(aes(z = fit, color = stat(level)),
               binwidth = 0.2) +
  scale_color_gradient(low = "white", high = crcblue) +
  metR::geom_text_contour(aes(z = fit))
}

```


```{r}
swinging_tendecy_scatter <- function(data, player) {
  #Add counts and add swung info
  swing <- c("Single", "Foul Ball", "Contact Out", "Swinging Strike", "Home Run", "Error", "Double", "Triple")
  data <- data %>% 
    filter(batter_name == player) %>%
    mutate(ball = as.numeric(balls),
           strike = as.numeric(strikes),
           count = paste(ball, strike, sep = "-"),
           swung = case_when(play_result %in% swing ~ 1, TRUE ~ 0))
  
  #strike zone plot
  k_zone_plot <- ggplot(data, aes(plate_x, plate_z)) +
  geom_segment(aes(x = -0.947, y = 3.6, xend = -0.947, yend = 1.5)) +
  geom_segment(aes(x = -0.947, y = 3.6, xend = 0.947, yend = 3.6)) + 
  geom_segment(aes(x = 0.947, y = 3.6, xend = 0.947, yend = 1.5)) + 
  geom_segment(aes(x = -0.947, y = 1.5, xend = 0.947, yend = 1.5)) +
  coord_equal() +
  scale_x_continuous("Horizontal location (ft.)",
                     limits = c(-2, 2)) +
  scale_y_continuous("Vertical location (ft.)",
                    limits = c(0, 5))
  #scatterplot
  k_zone_plot +
  geom_point(aes(color = factor(swung))) +
  scale_color_manual("Swung", values = c("gray70", "blue"),
                     labels = c("No", "Yes"))

}

swinging_tendecy_scatter(sc, "Branden Comia")

```



